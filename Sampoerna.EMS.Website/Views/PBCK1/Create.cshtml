@model Sampoerna.EMS.Website.Models.PBCK1.PBCK1ItemViewModel
@{
    ViewBag.Title = "Create";
}

@using (Html.BeginForm("Save", "PBCK1", new { @class = "form-excise", role = "form" }))
{
<div class="container-wrap title-page">
    <div class="row">
        <div class="col-sm-12">
            <h3>PBCK-1 Form</h3>
            <label class="status">Draft</label>
            <div class="action-button">
                @*<button class="btn btn-blue">Save</button>*@
                <input type="submit" id="SubmitType" name="SubmitType" class="btn btn-blue" value="Save" />
                <input type="submit" id="SubmitType" name="SubmitType" class="btn btn-grey" value="Print Preview" />
            </div>
        </div>
    </div>
</div>
<div class="container-wrap">
    <div class="row">
        <div class="col-sm-12">
            <div role="tabpanel">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" id="home-tab" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Information</a></li>
                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Print Out</a></li>
                    <li role="presentation" id="prod-plan-upload-tab"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">Upload Production Plan</a></li>
                    <li role="presentation" id="prod-conv-upload-tab"><a href="#upload" aria-controls="upload" role="tab" data-toggle="tab">Upload Production Converted</a></li>
                    <li role="presentation"><a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Changes Log</a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    @Html.Partial("_HomeCreate")
                    @Html.Partial("_PrintOut")
                    @Html.Partial("_ProdPlanUpload")
                    @Html.Partial("_ProdConvUpload")
                    @Html.Partial("_ChangeLog")
                </div>
            </div>
        </div>
    </div>
</div>
}

@section scripts {
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/Scripts/jquery.form.min.js"></script>
    <script src="~/Scripts/UploadExcel.js"></script>
    <script type="text/javascript">

        var supplierData;
        $(document).ready(function() {
            $('#prod-conv-save').click(function() {
                var datarows = GetTableData($('#prod-conv-table'));
                var columnLength = $('#pbck1-prod-conv-item').find("thead tr:first th").length;
                $('#pbck1-prod-conv-item tbody').html('');
                for (var i = 0; i < datarows.length; i++) {
                    var data = '<tr>';
                    if (columnLength > 0) {
                        data += '<td style="display:none">' + datarows[i][0] + '</td>';
                        data += '<td>' + datarows[i][1] + '</td>';
                        data += '<td>' + datarows[i][2] + '</td>';
                        data += '<td>' + datarows[i][3] + '</td>';
                        data += '<td>' + datarows[i][4] + '</td>';
                    }
                    data += '</tr>';
                    $('#pbck1-prod-conv-item tbody').append(data);
                }
                $('#prod-conv-upload-tab').removeClass('active');
                $('#home-tab').addClass('active');
                $('#home').addClass('active');
                $('#upload').removeClass('active');
            });
            $('#prod-plan-save').click(function() {
                var datarows = GetTableData($('#prod-plan-table'));
                var columnLength = $('#pbck1-prod-plan-item').find("thead tr:first th").length;
                $('#pbck1-prod-plan-item tbody').html('');
                for (var i = 0; i < datarows.length; i++) {
                    var data = '<tr>';
                    if (columnLength > 0) {
                        data += '<td style="display:none">' + datarows[i][0] + '</td>';
                        data += '<td style="display:none">' + datarows[i][1] + '</td>';
                        data += '<td>' + datarows[i][2] + '</td>';
                        data += '<td>' + datarows[i][3] + '</td>';
                        data += '<td>' + datarows[i][4] + '</td>';
                        data += '<td>' + datarows[i][5] + '</td>';
                    }
                    data += '</tr>';
                    $('#pbck1-prod-plan-item tbody').append(data);
                }
                $('#prod-plan-upload-tab').removeClass('active');
                $('#home-tab').addClass('active');
                $('#home').addClass('active');
                $('#messages').removeClass('active');
            });

            $('#ProdConvSubmitBtn').click(function() {
                var fileName = $('[name="ProdConvExcelfile"]').val().trim();
                var pos = fileName.lastIndexOf('.');
                var extension = (pos <= 0) ? '' : fileName.substring(pos);
                if (extension != '.xlsx') {
                    alert('Please browse a correct excel file to upload');
                    return false;
                }
                $('#FormProdConv').ajaxSubmit(function(data) {
                    $('#ProdConvContent').html("");
                    $('#ProdConvContent').html(data);

                });
                return false;
            });
            $('#ProdPlanSubmitBtn').click(function() {
                var fileName = $('[name="ProdPlanExcelfile"]').val().trim();
                var pos = fileName.lastIndexOf('.');
                var extension = (pos <= 0) ? '' : fileName.substring(pos);
                if (extension != '.xlsx') {
                    alert('Please browse a correct excel file to upload');
                    return false;
                }
                $('#FormProdPlan').ajaxSubmit(function(data) {
                    $('#ProdPlanContent').html("");
                    $('#ProdPlanContent').html(data);

                });
                return false;
            });

            $('#btn-prod-conv-upload').click(function() {
                $('#home-tab').removeClass('active');
                $('#home').removeClass('active');
                $('#prod-conv-upload-tab').addClass('active');
                $('#upload').addClass('active');
            });

            $('#btn-prod-plan-upload').click(function() {
                $('#home-tab').removeClass('active');
                $('#home').removeClass('active');
                $('#prod-plan-upload-tab').addClass('active');
                $('#messages').addClass('active');
            });

            ajaxLoadSupplierPlant();

        });

        $('#Detail_NPPBKC_ID').change(function() {
            if ($("#Detail_NPPBKC_ID").length) {
                var nppbkcid = $(this).find("option:selected").val();
                console.log(nppbkcid);
                if (nppbkcid != '') {
                    ajaxLoadNppbkcDetail({ nppbkcid: nppbkcid });
                } else {
                    $('#tbxcompanyname').val('');
                }
            }
        });

        function ajaxLoadNppbkcDetail(formData) {
            if (formData.nppbkcid) {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetNppbkcDetail", "PBCK1")',
                    data: formData,
                    success: function(data) {
                        if (data != null) {
                            $('#tbxcompanyname').val(data.DocumentBukrstxt);
                        } else {
                            $('#tbxcompanyname').val('');
                        }
                    }
                });
            }
        }

        $("#Detail_SUPPLIER_PORT_ID").change(function() {
            if ($("#Detail_SUPPLIER_PORT_ID").length) {
                var port_id = $(this).find("option:selected").val();
                console.log(port_id);
                $('#Detail_SUPPLIER_PLANT').remove();
                if (port_id == '') {
                    //
                    $('#supp-plant').html('<input class="form-control" id="Detail_SUPPLIER_PLANT" name="Detail.SUPPLIER_PLANT" type="text" />');
                    disableSupplierFormInput(false);
                    setSupplierPlantEmpty();
                } else {
                    loadSupplierPlant();
                    disableSupplierFormInput(true);
                }
            }
        });

        function disableSupplierFormInput(isDisable) {
            $('#txtSupplierNppbkc').prop('disabled', isDisable);
            $('#txtSupplierKppbc').prop('disabled', isDisable);
            $('#txtSupplierAddress').prop('disabled', isDisable);
            $('#txtSupplierPhone').prop('disabled', isDisable);
        }

        function ajaxLoadSupplierPlant() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetSupplierPlant", "PBCK1")',
                success: function(data) {
                    supplierData = data;
                }
            });
        }

        function loadSupplierPlant() {
            var list = supplierData;
            if (list.length > 0) {
                var htmlSelect = '';
                htmlSelect += '<select class="form-control" id="Detail_SUPPLIER_PLANT" name="Detail.SUPPLIER_PLANT" onchange="supplierChange();">';
                for (var i = 0; i < list.length; i++) {
                    htmlSelect += '<option value=' + list[i].Value + '>' + list[i].Text + '</option>';
                }
                htmlSelect += '</select>';
                $('#supp-plant').html(htmlSelect);
                //selected to 1
                if ($("#Detail_SUPPLIER_PLANT").length) {
                    var plant_id = $("#Detail_SUPPLIER_PLANT").find("option:selected").val();
                    console.log(plant_id);
                    ajaxLoadDetailSupplierPlant({ plantid: plant_id });
                }
            }
        }

        function ajaxLoadDetailSupplierPlant(formData) {
            $.ajax({
                type: 'POST',
                data: formData,
                url: '@Url.Action("GetSupplierPlantDetail", "PBCK1")',
                success: function(data) {

                    if (data != null) {
                        //load to form
                        $('#txtSupplierNppbkc').val(data.NPPBKC_NO);
                        $('#txtSupplierKppbc').val(data.KPPBC_NO);
                        $('#txtSupplierPhone').val('Ini no telp.');
                        $('#txtSupplierAddress').val(data.Address);
                    } else {
                        setSupplierPlantEmpty();
                    }
                }
            });
        }

        function supplierChange() {
            if ($("#Detail_SUPPLIER_PLANT").length) {
                var plantid = $("#Detail_SUPPLIER_PLANT").find("option:selected").val();
                console.log(plantid);
                ajaxLoadDetailSupplierPlant({ plantid: plantid });
            }
        }
        
        function setSupplierPlantEmpty() {
            $('#txtSupplierNppbkc').val('');
            $('#txtSupplierKppbc').val('');
            $('#txtSupplierPhone').val('');
            $('#txtSupplierAddress').val('');
        }

    </script>
}